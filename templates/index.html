<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <style>
    {% if not mobile %}
    .gallery {
        width:16.6%;
    }
    {% endif %}
    {% if mobile %}
    .gallery {
        width:33.3%;
    }
    {% endif %}
    </style>
</head>
<body>
<div id="main_area" style="display: inline-block;background-color: #404040;align:center;"></div>
<script>
    const step = 90;
    var end = 0;
    var detect = false;
    function add(data){
        console.log(data);
        for(let o of data){
            let d = $("<div style='display: inline-block;margin:0 auto;' class='gallery'></div>");
            let a = $("<a href='/book/"+o[0]+"' style='text-decoration:none;margin:0 auto;'></a>");
            let img = $("<img class='img lazy' data-src='/icon/"+o[0]+"', style='display: block;margin:0 auto;width:100%;'>");
            let p = $("<p style='color: #d9d9d9;'></p>").text(o[1]);
            d.append(a.append(img).append(p));
            $("#main_area").append(d);
            img.css("height","5000px");
            watcher.observe(img[0]) // 開始監視
        }
        end += data.length;
        detect = true;
    }
    $.post("/get", {"stop": "30"},function(data,status){add(data);});
    function addDemo() {
        let documentElement = document.documentElement
        if (documentElement.scrollTop + 500 >= documentElement.scrollHeight - documentElement.clientHeight) {
            if (detect){
                detect = false;
                $.post("/get", {"start": ""+end, "stop":""+(step+end)},function(data,status){add(data);});
            }
        }
    }
    window.addEventListener('scroll', addDemo);
    function onEnterView(entries, observer) {
        for (let entry of entries) {
            if (entry.isIntersecting) {
                // 監視目標進入畫面
                const img = entry.target
                img.setAttribute('src', img.dataset.src) // 把值塞回 src
                img.removeAttribute('data-src')
                $(img).css("height","auto");
                observer.unobserve(img) // 取消監視
            }
        }
    }
    const watcher = new IntersectionObserver(onEnterView)
    const lazyImages = document.querySelectorAll('img.lazy')
    for (let image of lazyImages) {
        $(image).css("height","5000px");
        watcher.observe(image) // 開始監視
    }
</script>
</body>
</html>